<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home Services Marketplace</title>

  <style>
    /* ===== RESET & BASE ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      color: #333;
    }

    /* ===== LANDING PAGE ===== */
    .landing-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .landing-card {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .3);
      max-width: 1000px;
      width: 100%;
      overflow: hidden;
    }

    .landing-header {
      background: linear-gradient(135deg, #232f3e 0%, #3a4d5f 100%);
      padding: 60px 40px;
      text-align: center;
      color: #fff;
    }

    .landing-header h1 {
      font-size: 3em;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, .3);
    }

    .landing-header p {
      font-size: 1.3em;
      opacity: .95;
    }

    .landing-content {
      padding: 60px 40px;
    }

    .portal-selection {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }

    .portal-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 40px 30px;
      border-radius: 15px;
      text-align: center;
      cursor: pointer;
      transition: .3s;
      box-shadow: 0 5px 15px rgba(0, 0, 0, .2);
    }

    .portal-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, .3);
    }

    .portal-card.provider {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .portal-card .icon {
      font-size: 3.5em;
      margin-bottom: 15px;
    }

    .portal-card h2 {
      margin-bottom: 10px;
    }

    .features {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 10px;
      margin-top: 30px;
    }

    .features h3 {
      color: #1e3c72;
      margin-bottom: 20px;
      text-align: center;
    }

    .features ul {
      list-style: none;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      padding-left: 0;
    }

    .features li {
      padding: 10px;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, .1);
    }

    .features li::before {
      content: "‚úì ";
      color: #28a745;
      font-weight: 700;
      margin-right: 8px;
    }

    /* ===== VIEW CONTAINERS ===== */
    .view-container {
      display: none;
      min-height: 100vh;
      background: #f5f5f5;
    }

    .view-container.active {
      display: block;
    }

    /* ===== HEADER ===== */
    .header {
      background: linear-gradient(135deg, #232f3e 0%, #3a4d5f 100%);
      color: #fff;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .2);
      flex-wrap: wrap;
      gap: 15px;
    }

    .header h1 {
      font-size: 1.8em;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, .2);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 14px;
    }

    /* ===== BUTTONS ===== */
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: .2s;
    }

    .btn-primary {
      background: #ff9900;
      color: #fff;
    }

    .btn-primary:hover {
      background: #e88b00;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, .2);
      color: #fff;
      border: 1px solid #fff;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, .3);
    }

    .btn-danger {
      background: #dc3545;
      color: #fff;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== CONTAINERS ===== */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .shell-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .content-card {
      background: #fff;
      border-radius: 10px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .1);
    }

    .search-section {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .1);
    }

    .search-section h2 {
      color: #232f3e;
      margin-bottom: 20px;
      font-size: 1.5em;
    }

    /* ===== FORMS ===== */
    .form-group {
      margin: 15px 0;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 700;
      color: #555;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background: #fff;
      transition: border-color 0.3s;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #ff9900;
    }

    button {
      background: #ff9900;
      color: #fff;
      padding: 12px 30px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 700;
      transition: all 0.3s;
      width: 100%;
    }

    button:hover {
      background: #e88b00;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* ===== SERVICE CATEGORIES ===== */
    .service-categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .category-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 25px 15px;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: .3s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, .1);
    }

    .category-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, .2);
    }

    .category-card .icon {
      font-size: 3em;
      margin-bottom: 10px;
    }

    .category-card h3 {
      font-size: 1.2em;
      margin-bottom: 5px;
    }

    /* ===== SERVICE CARDS ===== */
    .service-card {
      background: #fff;
      border: 2px solid #e0e0e0;
      padding: 25px;
      margin: 15px 0;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
      transition: all 0.3s;
    }

    .service-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, .15);
      border-color: #ff9900;
    }

    .service-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
      gap: 12px;
    }

    .service-title {
      flex: 1;
    }

    .service-title h3 {
      color: #232f3e;
      font-size: 1.4em;
      margin-bottom: 5px;
    }

    .service-price {
      background: #ff9900;
      color: #fff;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 1.3em;
      font-weight: 700;
      min-width: 80px;
      text-align: center;
    }

    .service-description {
      color: #666;
      margin: 10px 0;
      line-height: 1.6;
    }

    .service-details {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 15px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 5px;
    }

    .service-detail {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .provider-info {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
    }

    .provider-info strong {
      color: #2e7d32;
    }

    .provider-details {
      color: #555;
    }

    .rating {
      color: #ff9900;
      font-size: 1.1em;
    }

    /* ===== STATUS BADGES ===== */
    .status {
      display: inline-block;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      background: #fff3cd;
      color: #856404;
      margin: 5px 0;
    }

    .status-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-confirmed {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-in_progress {
      background: #cce5ff;
      color: #004085;
    }

    .status-completed {
      background: #d4edda;
      color: #155724;
    }

    .status-paid {
      background: #d4edda;
      color: #155724;
    }

    .status-cancelled {
      background: #f8d7da;
      color: #721c24;
    }

    /* ===== MODALS ===== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, .7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(3px);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal.active {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background: #fff;
      border-radius: 15px;
      padding: 30px;
      max-width: 600px;
      width: 92%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .35);
      transform: scale(0.9);
      transition: transform 0.3s ease;
      position: relative;
    }

    .modal.active .modal-content {
      transform: scale(1);
    }

    .modal-header {
      margin-bottom: 20px;
    }

    .modal-header h2 {
      color: #232f3e;
      margin-bottom: 8px;
    }

    .modal-body {
      margin-bottom: 24px;
      line-height: 1.6;
      color: #555;
    }

    .modal-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .modal-actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .modal-note {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      margin: 16px 0;
      font-size: 14px;
      color: #666;
      text-align: center;
    }

    .close-btn {
      position: absolute;
      right: 20px;
      top: 20px;
      font-size: 28px;
      cursor: pointer;
      color: #999;
    }

    .close-btn:hover {
      color: #333;
    }

    /* ===== PROVIDER DASHBOARD ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .05);
    }

    .stat-card.blue {
      background: #e3f2fd;
    }

    .stat-card.orange {
      background: #fff3e0;
    }

    .stat-card.teal {
      background: #e0f2f1;
    }

    .stat-card.purple {
      background: #f3e5f5;
    }

    .stat-card.dark-green {
      background: #dcedc8;
    }

    .stat-value {
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .booking-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin: 12px 0;
      border-left: 4px solid #007bff;
    }

    .booking-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .action-buttons {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #ddd;
    }

    .status-updater {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .status-updater select {
      flex: 1;
      padding: 10px;
      font-weight: 600;
    }

    .status-updater button {
      width: auto;
      padding: 10px 20px;
    }

    .terminal-status {
      font-weight: 700;
      font-size: 14px;
      padding: 10px 0;
    }

    /* ===== PAGINATION ===== */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 20px 0;
    }

    .pagination button {
      width: auto;
      padding: 8px 16px;
    }

    /* ===== UTILITIES ===== */
    .hidden {
      display: none !important;
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2em;
      color: #666;
    }

    .info-box {
      background: #d1ecf1;
      color: #0c5460;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      border: 1px solid #bee5eb;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .landing-header h1 {
        font-size: 2em;
      }

      .header {
        padding: 15px 20px;
      }

      .header h1 {
        font-size: 1.4em;
      }

      .service-header {
        flex-direction: column;
      }

      .service-price {
        margin-top: 10px;
      }

      .modal-content {
        padding: 20px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  
    /* üü¢ NEW: Review & Star Styles */
    .review-scroll-box { margin-top: 12px; padding-top: 12px; border-top: 1px solid #c8e6c9; max-height: 150px; overflow-y: auto; }
    .review-item { background: rgba(255,255,255,0.6); padding: 8px; border-radius: 5px; margin-top: 6px; font-size: 0.9em; }
    .review-header { display: flex; justify-content: space-between; font-size: 0.85em; color: #666; margin-bottom: 2px; }
    .review-text { font-style: italic; color: #333; }
    .star-rating span { font-size: 30px; cursor: pointer; color: #ccc; transition: color 0.2s; }
    .star-rating span.active { color: #ff9900; }

  </style>
</head>

<body>

  <div id="landingPage" class="landing-container">
    <div class="landing-card">
      <div class="landing-header">
        <h1>üè† HOME SERVICES MARKETPLACE</h1>
        <p>Professional Services at Your Doorstep</p>
      </div>

      <div class="landing-content">
        <div class="portal-selection">
          <div class="portal-card" onclick="showCustomerView()">
            <div class="icon">üë•</div>
            <h2>Customer Portal</h2>
            <p>Browse services, book appointments, and track your orders</p>
          </div>

          <div class="portal-card provider" onclick="showProviderLogin()">
            <div class="icon">üë®‚Äçüîß</div>
            <h2>Provider & Admin</h2>
            <p>Manage bookings, update service status, and view analytics</p>
          </div>
        </div>

        <div class="features">
          <h3>Why Choose Us?</h3>
          <ul>
            <li>Verified Professional Service Providers</li>
            <li>Transparent Fixed Pricing</li>
            <li>Easy Online Booking</li>
            <li>Real-time Status Updates</li>
            <li>Secure Cash Payments</li>
            <li>Quality Service Guarantee</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div id="customerView" class="view-container">
    <div class="header">
      <h1>üè† Home Services Marketplace</h1>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="showLanding()">‚Üê Back to Home</button>
      </div>
    </div>

    <div class="container">
      <div class="search-section">
        <h2>Browse Services by Category</h2>
        <div class="service-categories">
          <div class="category-card" onclick="searchByCategory('electrician')">
            <div class="icon">‚ö°</div>
            <h3>Electrician</h3>
            <p>Wiring, repairs, installations</p>
          </div>

          <div class="category-card" onclick="searchByCategory('plumber')">
            <div class="icon">üîß</div>
            <h3>Plumber</h3>
            <p>Pipes, fixtures, drainage</p>
          </div>

          <div class="category-card" onclick="searchByCategory('carpenter')">
            <div class="icon">ü™ö</div>
            <h3>Carpenter</h3>
            <p>Furniture, repairs, custom work</p>
          </div>

          <div class="category-card" onclick="searchByCategory('painter')">
            <div class="icon">üé®</div>
            <h3>Painter</h3>
            <p>Interior, exterior painting</p>
          </div>

          <div class="category-card" onclick="searchByCategory('hvac')">
            <div class="icon">‚ùÑÔ∏è</div>
            <h3>HVAC</h3>
            <p>Heating, cooling, ventilation</p>
          </div>
        </div>
      </div>

      <div class="search-section">
        <h2>üîç Search Services</h2>
        <div class="form-group">
          <label for="category">Service Category</label>
          <select id="category">
            <option value="">Select a category...</option>
            <option value="electrician">Electrician</option>
            <option value="plumber">Plumber</option>
            <option value="carpenter">Carpenter</option>
            <option value="painter">Painter</option>
            <option value="hvac">HVAC</option>
          </select>
        </div>

        <div class="form-group">
          <label for="location">Location</label>
          <input type="text" id="location" placeholder="e.g., Toronto, Mississauga" />
        </div>

        <div class="form-group">
          <label for="maxPrice">Maximum Price (CAD)</label>
          <input type="number" id="maxPrice" placeholder="e.g., 500" />
        </div>

        <button onclick="searchServices()">Search Services</button>
      </div>

      <div id="results" class="hidden">
        <h2>Available Services</h2>
        <div id="servicesList"></div>
      </div>

      <div class="search-section">
        <h2>üìã My Bookings</h2>
        <div class="info-box">
          <strong>üí° Tip:</strong> Save your Customer ID after booking to track your orders.
        </div>

        <div class="form-group">
          <label for="customerIdLookup">Enter your Customer ID</label>
          <input type="text" id="customerIdLookup" placeholder="e.g., cust-demo-1234567890" />
        </div>

        <button onclick="loadMyBookings()">View My Bookings</button>

        <div id="myBookings" class="hidden" style="margin-top: 20px;">
          <div id="bookingsList"></div>
          <div id="bookingsPagination" class="pagination hidden">
            <button id="prevBookings" onclick="loadMyBookings('prev')">‚Üê Previous</button>
            <span id="bookingsPageInfo">Page 1</span>
            <button id="nextBookings" onclick="loadMyBookings('next')">Next ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <div id="bookingModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeBookingModal()">&times;</span>
        <div class="modal-header">
          <h2>Book This Service</h2>
        </div>

        <div id="modalServiceDetails"></div>

        <form id="bookingForm">
          <div class="form-group">
            <label for="customerName">Your Name *</label>
            <input type="text" id="customerName" required />
          </div>

          <div class="form-group">
            <label for="customerPhone">Phone Number *</label>
            <input type="tel" id="customerPhone" required placeholder="+1-416-555-0100" />
          </div>

          <div class="form-group">
            <label for="customerEmail">Email Address *</label>
            <input type="email" id="customerEmail" required placeholder="you@example.com" />
          </div>

          <div class="form-group">
            <label for="customerAddress">Service Address *</label>
            <textarea id="customerAddress" rows="3" required placeholder="Enter full address including city and postal code"></textarea>
          </div>

          <div class="form-group">
            <label for="scheduledDate">Preferred Date *</label>
            <input type="date" id="scheduledDate" required />
          </div>

          <div class="form-group">
            <label for="notes">Additional Notes</label>
            <textarea id="notes" rows="3" placeholder="Any specific requirements or details..."></textarea>
          </div>

          <div class="modal-note">
            <strong>Payment:</strong> Cash payment required upon service completion.<br>
            <strong>Note:</strong> Provider will contact you to confirm the appointment.
          </div>

          <button type="submit">Confirm Booking</button>
        </form>
      </div>
    </div>
  </div>


  <div id="reviewModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeReviewModal()">&times;</span>
      <div class="modal-header"><h2>Rate Your Provider</h2></div>
      <form id="reviewForm">
        <input type="hidden" id="reviewBookingId"><input type="hidden" id="reviewProviderId">
        <div class="form-group">
          <label>Rating</label>
          <div class="star-rating" id="starContainer">
            <span onclick="setRating(1)">‚òÖ</span><span onclick="setRating(2)">‚òÖ</span>
            <span onclick="setRating(3)">‚òÖ</span><span onclick="setRating(4)">‚òÖ</span><span onclick="setRating(5)">‚òÖ</span>
          </div>
          <input type="hidden" id="ratingValue" required>
        </div>
        <div class="form-group"><label>Comments</label><textarea id="reviewComment" rows="4"></textarea></div>
        <button type="submit">Submit Review</button>
      </form>
    </div>
  </div>

  <div id="providerView" class="view-container">
    <div class="header">
      <h1>üë®‚Äçüîß Provider Dashboard</h1>
      <div class="header-actions">
        <span id="providerName" class="user-badge"></span>
        <button class="btn btn-secondary" onclick="providerLogout()">Sign Out</button>
      </div>
    </div>

    <div id="providerContent" class="shell-container">
      <div class="content-card">
        <h2>üìä Loading Dashboard...</h2>
        <p>Please wait while we load your information...</p>
      </div>
    </div>
  </div>

  <div id="loginModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üîê Provider Access</h2>
        <p>Sign in or register to manage bookings</p>
      </div>

      <div class="modal-actions">
        <button onclick="loginWithCognito()" class="btn btn-primary">Login with AWS Cognito</button>
        <button onclick="signupWithCognito()" class="btn" style="background:#3b82f6;color:#fff">Register New Provider</button>
        <button onclick="forgotPassword()" class="btn" style="background:#6b7280;color:#fff">Forgot Password</button>
        <button onclick="closeLoginModal()" class="btn btn-secondary">Cancel</button>
      </div>

      <p class="modal-note">You will be redirected to AWS Cognito Hosted UI.</p>
    </div>
  </div>

  <div id="alertModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="alertTitle">Alert</h2>
      </div>
      <div id="alertMessage" class="modal-body"></div>
      <div class="modal-actions">
        <button id="alertOkBtn" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="confirmTitle">Confirm Action</h2>
      </div>
      <div id="confirmMessage" class="modal-body"></div>
      <div class="modal-actions-row">
        <button id="confirmCancelBtn" class="btn btn-secondary">Cancel</button>
        <button id="confirmOkBtn" class="btn btn-danger">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== CONFIGURATION ===== */
    const CONFIG = {
      apiUrl: 'https://n5wzcy3kib.execute-api.us-east-1.amazonaws.com/dev',
      cognito: {
        region: 'us-east-1',
        userPoolId: 'us-east-1_53eHGiilR',
        clientId: 'b7llg18v90jbd425pqkrljutu',
        domain: 'https://us-east-153ehgiilr.auth.us-east-1.amazoncognito.com',
        cloudfrontBase: 'https://d3r7plath9y10q.cloudfront.net',
        localhostFile: 'http://localhost:5500/unified-marketplace-portal.html'
      }
    };

    function resolveRedirectUri() {
      const host = window.location.hostname;
      if (host === 'localhost') return CONFIG.cognito.localhostFile;
      if (host.includes('d3r7plath9y10q.cloudfront.net')) return CONFIG.cognito.cloudfrontBase;
      return window.location.origin + window.location.pathname;
    }

    /* ===== STATE VARIABLES ===== */
    let currentUser = null;
    let idToken = null;
    let selectedService = null;
    let bookingsPaginationToken = null;
    let bookingsPaginationHistory = [];
    let currentPage = 1;
    // üü¢ NEW: Variables for Filter & Reviews
    let allProviderBookings = []; 
    let currentRating = 0; 
    let currentSearchResults = [];

    /* ===== INITIALIZATION & MAGIC LINK ===== */
    window.onload = () => {
      checkAuthCallback();
      // Check if user clicked email link
      const urlParams = new URLSearchParams(window.location.search);
      const emailCustId = urlParams.get('customerId');
      if (emailCustId) {
          showCustomerView();
          document.getElementById('customerIdLookup').value = emailCustId;
          loadMyBookings();
      }
    };

    /* ===== VIEW SWITCHING ===== */
    function hideAllViews() {
      document.getElementById('landingPage').style.display = 'none';
      document.getElementById('customerView').classList.remove('active');
      document.getElementById('providerView').classList.remove('active');
    }

    function showLanding() {
      hideAllViews();
      document.getElementById('landingPage').style.display = 'flex';
    }

    function showCustomerView() {
      hideAllViews();
      document.getElementById('customerView').classList.add('active');
      const lastId = sessionStorage.getItem('lastCustomerId');
      if (lastId) {
        const customerInput = document.getElementById('customerIdLookup');
        if (customerInput) customerInput.value = lastId;
      }
    }

    function showProviderView() {
      hideAllViews();
      document.getElementById('providerView').classList.add('active');
      loadProviderContent();
    }

    function showProviderLogin() {
      document.getElementById('loginModal').classList.add('active');
    }

    function closeLoginModal() {
      document.getElementById('loginModal').classList.remove('active');
    }

    /* ===== MODAL UTILITIES ===== */
    function showAlert(message, title = 'Alert') {
      return new Promise(resolve => {
        const modal = document.getElementById('alertModal');
        const titleEl = document.getElementById('alertTitle');
        const messageEl = document.getElementById('alertMessage');
        const okBtn = document.getElementById('alertOkBtn');

        titleEl.textContent = title;
        messageEl.innerHTML = message;
        modal.classList.add('active');

        const handleOk = () => {
          modal.classList.remove('active');
          okBtn.removeEventListener('click', handleOk);
          resolve(true);
        };

        okBtn.addEventListener('click', handleOk);
      });
    }

    function showConfirm(message, title = 'Confirm Action', okLabel = 'Confirm', cancelLabel = 'Cancel') {
      return new Promise(resolve => {
        const modal = document.getElementById('confirmModal');
        const titleEl = document.getElementById('confirmTitle');
        const messageEl = document.getElementById('confirmMessage');
        const okBtn = document.getElementById('confirmOkBtn');
        const cancelBtn = document.getElementById('confirmCancelBtn');

        titleEl.textContent = title;
        messageEl.innerHTML = message;
        okBtn.textContent = okLabel;
        cancelBtn.textContent = cancelLabel;
        modal.classList.add('active');

        const handleOk = () => {
          modal.classList.remove('active');
          cleanup();
          resolve(true);
        };

        const handleCancel = () => {
          modal.classList.remove('active');
          cleanup();
          resolve(false);
        };

        function cleanup() {
          okBtn.removeEventListener('click', handleOk);
          cancelBtn.removeEventListener('click', handleCancel);
        }

        okBtn.addEventListener('click', handleOk);
        cancelBtn.addEventListener('click', handleCancel);
      });
    }

    /* ===== AUTHENTICATION ===== */
    function loginWithCognito() {
      const redirectUri = encodeURIComponent(resolveRedirectUri());
      const url = `${CONFIG.cognito.domain}/login?client_id=${CONFIG.cognito.clientId}&response_type=token&scope=email+openid+profile&redirect_uri=${redirectUri}`;
      window.location.href = url;
    }

    function signupWithCognito() {
      const redirectUri = encodeURIComponent(resolveRedirectUri());
      const url = `${CONFIG.cognito.domain}/signup?client_id=${CONFIG.cognito.clientId}&response_type=token&scope=email+openid+profile&redirect_uri=${redirectUri}`;
      window.location.href = url;
    }

    function forgotPassword() {
      const redirectUri = encodeURIComponent(resolveRedirectUri());
      const url = `${CONFIG.cognito.domain}/login?client_id=${CONFIG.cognito.clientId}&response_type=token&scope=email+openid+profile&redirect_uri=${redirectUri}`;
      window.location.href = url;
    }

    function providerLogout() {
      sessionStorage.clear();
      idToken = null;
      currentUser = null;
      const logoutUri = encodeURIComponent(resolveRedirectUri());
      const url = `${CONFIG.cognito.domain}/logout?client_id=${CONFIG.cognito.clientId}&logout_uri=${logoutUri}`;
      window.location.href = url;
    }

    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
          atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')
        );
        return JSON.parse(jsonPayload);
      } catch (error) {
        console.error('JWT parse error:', error);
        return {};
      }
    }

    function checkAuthCallback() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      idToken = params.get('id_token');

      if (idToken) {
        const payload = parseJwt(idToken);
        currentUser = {
          email: payload.email,
          name: payload.name || payload.email,
          sub: payload.sub,
          providerId: payload['custom:providerId'] || null,
          groups: payload['cognito:groups'] || []
        };

        sessionStorage.setItem('idToken', idToken);
        sessionStorage.setItem('user', JSON.stringify(currentUser));
        window.history.replaceState({}, document.title, window.location.pathname);
        closeLoginModal();
        showProviderView();
      } else {
        const storedToken = sessionStorage.getItem('idToken');
        const storedUser = sessionStorage.getItem('user');
        if (storedToken && storedUser) {
          idToken = storedToken;
          currentUser = JSON.parse(storedUser);
        }
      }
    }

    /* ===== PROVIDER DASHBOARD ===== */
    async function loadProviderContent() {
      if (!currentUser || !idToken) {
        showProviderLogin();
        return;
      }

      const providerNameEl = document.getElementById('providerName');
      if (providerNameEl) {
        providerNameEl.textContent = `üë§ ${currentUser.name || currentUser.email}`;
      }

      const container = document.getElementById('providerContent');
      container.innerHTML = '<div class="content-card"><h2>üìä Loading Dashboard...</h2></div>';

      try {
        const response = await fetch(`${CONFIG.apiUrl}/bookings?providerId=${currentUser.providerId}`, {
          headers: {
            'Authorization': `Bearer ${idToken}`
          }
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        allProviderBookings = data.bookings || []; // Store for filtering

        const normalize = s => (s || '').toUpperCase();
        const stats = {
          total: allProviderBookings.length,
          pending: allProviderBookings.filter(b => ['PENDING', 'PENDING_CONFIRMATION'].includes(normalize(b.status))).length,
          confirmed: allProviderBookings.filter(b => normalize(b.status) === 'CONFIRMED').length,
          in_progress: allProviderBookings.filter(b => normalize(b.status) === 'IN_PROGRESS').length,
          completed: allProviderBookings.filter(b => normalize(b.status) === 'COMPLETED').length,
          paid: allProviderBookings.filter(b => normalize(b.status) === 'PAID').length,
          revenue: allProviderBookings.filter(b => normalize(b.status) === 'PAID').reduce((sum, b) => sum + (parseFloat(b.servicePrice) || 0), 0)
        };

        const roleTitle = currentUser.groups?.includes('Admins') ? 'Administrator' : 'Provider';

        container.innerHTML = `
          <div class="content-card">
            <h2>Welcome, ${currentUser.name}</h2>
            <p>Role: <strong>${roleTitle}</strong></p>
            <p>Provider ID: ${currentUser.providerId || 'Not assigned'}</p>
          </div>

          <div class="content-card">
            <h2>üìä Statistics</h2>
            <div class="stats-grid">
              <div class="stat-card blue">
                <div class="stat-value" style="color:#1976d2">${stats.total}</div>
                <div class="stat-label">Total Bookings</div>
              </div>
              <div class="stat-card orange">
                <div class="stat-value" style="color:#f57c00">${stats.pending}</div>
                <div class="stat-label">Pending</div>
              </div>
              <div class="stat-card teal">
                <div class="stat-value" style="color:#00796b">${stats.in_progress}</div>
                <div class="stat-label">In Progress</div>
              </div>
              <div class="stat-card purple">
                <div class="stat-value" style="color:#7b1fa2">${stats.completed}</div>
                <div class="stat-label">Completed</div>
              </div>
              <div class="stat-card dark-green">
                <div class="stat-value" style="color:#2e7d32;font-size:1.8em">${stats.revenue.toFixed(2)}</div>
                <div class="stat-label">Revenue (CAD)</div>
              </div>
            </div>
          </div>

          <div class="content-card">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:20px;">
                <h3>üìã Manage Bookings</h3>
                <div style="display:flex;gap:10px;align-items:center;">
                    <label for="statusFilter" style="font-weight:600;">Filter:</label>
                    <select id="statusFilter" onchange="applyProviderFilters()" style="padding:8px;border-radius:6px;border:1px solid #ddd;">
                        <option value="ALL">All Statuses</option>
                        <option value="PENDING">‚ö†Ô∏è Pending Action</option>
                        <option value="CONFIRMED">üìÖ Confirmed</option>
                        <option value="IN_PROGRESS">‚ñ∂ In Progress</option>
                        <option value="COMPLETED">‚úì Completed</option>
                        <option value="PAID">üí∞ Paid</option>
                        <option value="CANCELLED">‚ùå Cancelled</option>
                    </select>
                </div>
            </div>
            <div id="providerBookingsList"></div>
          </div>
        `;

        applyProviderFilters(); // Initial render
      } catch (error) {
        console.error('Error loading provider content:', error);
        container.innerHTML = `
          <div class="content-card">
            <h2>‚ùå Error Loading Dashboard</h2>
            <p>${error.message}</p>
            <button class="btn btn-primary" onclick="loadProviderContent()">Retry</button>
          </div>
        `;
      }
    }

    function applyProviderFilters() {
        const filterValue = document.getElementById('statusFilter').value;
        const filteredList = allProviderBookings.filter(booking => {
            if (filterValue === 'ALL') return true;
            const status = (booking.status || '').toUpperCase();
            if (filterValue === 'PENDING') return status.includes('PENDING');
            return status === filterValue;
        });
        displayProviderBookings(filteredList);
    }

    function displayProviderBookings(bookings) {
      const listDiv = document.getElementById('providerBookingsList');
      if (!bookings || bookings.length === 0) {
        listDiv.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">No bookings found matching this filter.</p>';
        return;
      }
      
      // Sort newest first
      bookings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      listDiv.innerHTML = bookings.map(booking => {
        const status = (booking.status || '').toUpperCase();
        const statusClass = {
          'PENDING': 'status-pending',
          'PENDING_CONFIRMATION': 'status-pending',
          'CONFIRMED': 'status-confirmed',
          'IN_PROGRESS': 'status-in_progress',
          'COMPLETED': 'status-completed',
          'PAID': 'status-paid',
          'CANCELLED': 'status-cancelled'
        } [status] || 'status-pending';

        return `
          <div class="booking-card">
            <div class="booking-header">
              <div>
                <h3>${booking.serviceName || 'Service'}</h3>
                <p style="font-size:0.9em;color:#666;">Booking ID: ${booking.bookingId}</p>
                <p style="font-size:0.85em;color:#999;">Customer ID: ${booking.customerId}</p>
              </div>
              <span class="status-badge ${statusClass}">${status.replace(/_/g, ' ')}</span>
            </div>
            
            <div style="background:#f1f8e9;padding:15px;border-radius:8px;margin:15px 0;border:1px solid #c8e6c9;">
                <h4 style="margin-bottom:10px;color:#2e7d32;border-bottom:1px solid #a5d6a7;padding-bottom:5px;">üë§ Customer Details</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;">
                    <div><strong>Name:</strong> ${booking.customerName || 'N/A'}</div>
                    <div><strong>Phone:</strong> <a href="tel:${booking.customerPhone}" style="color:#1e3c72;text-decoration:none;">${booking.customerPhone || 'N/A'}</a></div>
                    <div><strong>Email:</strong> <a href="mailto:${booking.customerEmail}" style="color:#1e3c72;text-decoration:none;">${booking.customerEmail || 'N/A'}</a></div>
                </div>
                <div style="margin-top:10px;"><strong>üìç Service Address:</strong><br>${booking.customerAddress || 'N/A'}</div>
            </div>

            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin:10px 0;">
              <div><strong>üí∞ Price:</strong> ${(parseFloat(booking.servicePrice) || 0).toFixed(2)}</div>
              <div><strong>üìÖ Date:</strong> ${booking.scheduledDate || 'TBD'}</div>
            </div>
            ${booking.notes ? `<p style="margin-top:10px;background:#fff3e0;padding:10px;border-radius:5px;"><strong>üìù Notes:</strong> ${booking.notes}</p>` : ''}
            <div class="action-buttons">${generateActionDropdown(booking)}</div>
          </div>
        `;
      }).join('');
    }

    function generateActionDropdown(booking) {
      const status = (booking.status || '').toUpperCase();
      let options = '';
      let terminal = null;

      switch (status) {
        case 'PENDING':
        case 'PENDING_CONFIRMATION':
          options = '<option value="confirmed">‚úì Confirm</option><option value="cancelled">‚úó Cancel</option>';
          break;
        case 'CONFIRMED':
          options = '<option value="in_progress">‚ñ∂ Start</option><option value="cancelled">‚úó Cancel</option>';
          break;
        case 'IN_PROGRESS':
          options = '<option value="completed">‚úì Complete</option>';
          break;
        case 'COMPLETED':
          options = '<option value="paid">üí∞ Mark Paid</option>';
          break;
        case 'PAID':
          terminal = '<span class="terminal-status" style="color:#2e7d32;">‚úì Service Paid</span>';
          break;
        case 'CANCELLED':
          terminal = '<span class="terminal-status" style="color:#dc3545;">‚úó Cancelled</span>';
          break;
        default:
          terminal = '<span class="terminal-status">Unknown Status</span>';
      }

      if (terminal) return terminal;

      return `
        <div class="status-updater">
          <select id="status-select-${booking.bookingId}">
            <option disabled selected>Update status...</option>
            ${options}
          </select>
          <button class="btn btn-primary" onclick="handleStatusUpdate('${booking.bookingId}')">Update</button>
        </div>
      `;
    }

    async function handleStatusUpdate(bookingId) {
      const select = document.getElementById(`status-select-${bookingId}`);
      const newStatus = select.value;

      if (!newStatus) {
        await showAlert('Please select a status first.');
        return;
      }

      const confirmed = await showConfirm(
        `Update booking to "${newStatus.replace('_', ' ')}"?`,
        'Confirm Status Change',
        'Yes, Update'
      );

      if (!confirmed) return;

      try {
        const response = await fetch(`${CONFIG.apiUrl}/bookings/${bookingId}/status`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${idToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status: newStatus
          })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        await showAlert('‚úÖ Status updated successfully!', 'Success');
        loadProviderContent();
      } catch (error) {
        await showAlert(`‚ùå Update failed: ${error.message}`, 'Error');
      }
    }

    /* ===== CUSTOMER FUNCTIONS ===== */
    function searchByCategory(category) {
      document.getElementById('category').value = category;
      searchServices();
    }

    async function searchServices() {
      const category = document.getElementById('category').value;
      const location = document.getElementById('location').value;
      const maxPrice = document.getElementById('maxPrice').value;

      if (!category) {
        await showAlert('Please select a service category');
        return;
      }

      const resultsDiv = document.getElementById('results');
      const listDiv = document.getElementById('servicesList');
      resultsDiv.classList.remove('hidden');
      listDiv.innerHTML = '<div class="loading">üîç Searching for services...</div>';

      try {
        let url = `${CONFIG.apiUrl}/services?category=${encodeURIComponent(category)}`;
        if (location) url += `&location=${encodeURIComponent(location)}`;
        if (maxPrice) url += `&maxPrice=${maxPrice}`;

        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

        const result = await response.json();
        const services = result.services || result.data || [];

        if (services.length > 0) {
          displayServices(services);
        } else {
          listDiv.innerHTML = '<div class="content-card"><strong>No services found.</strong><br>Try adjusting your search criteria.</div>';
        }
      } catch (error) {
        console.error('Error:', error);
        listDiv.innerHTML = `<div class="content-card"><strong>Error searching services:</strong><br>${error.message}</div>`;
      }
    }
   
    function displayServices(services) {
      const listDiv = document.getElementById('servicesList');
      listDiv.innerHTML = '';

      services.forEach(service => {
        const card = document.createElement('div');
        card.className = 'service-card';

        const serviceName = service.name || 'Unnamed Service';
        const serviceDesc = service.description || 'No description';
        const servicePrice = parseFloat(service.price || 0).toFixed(2);
        const serviceDuration = service.duration || 'TBD';
        const availability = service.availability || 'available';
        const providerName = service.providerName || 'Unknown Provider';
        
        // üü¢ Data from Service Table
        const rating = parseFloat(service.rating || 0).toFixed(1);
        const count = service.reviewCount || 0;

        const availabilityBadge = availability !== 'available' ?
          `<span class="status" style="margin-left:10px;">${availability}</span>` : '';

        // üü¢ BUILD REVIEW LIST HTML
        let reviewsHtml = '';
        if (service.reviews && service.reviews.length > 0) {
            reviewsHtml = `<div class="review-scroll-box" style="margin-top:15px; padding-top:10px; border-top:1px solid #eee; background:#fff9f0; border-radius:5px;">
                           <div style="font-size:0.85em; color:#888; margin-bottom:5px; padding:0 5px;">Recent Feedback:</div>`;
            
            service.reviews.forEach(r => {
                const stars = '‚òÖ'.repeat(Math.round(r.rating)) + '‚òÜ'.repeat(5 - Math.round(r.rating));
                reviewsHtml += `
                <div class="review-item" style="background:none; border:none; padding:5px 8px; margin-bottom:5px;">
                    <div style="display:flex; justify-content:space-between; font-size:0.85em; color:#555;">
                        <span><strong>${r.reviewerName}</strong> <span style="color:#ff9900;">${stars}</span></span>
                        <span>${r.date}</span>
                    </div>
                    <div style="font-style:italic; color:#444; font-size:0.9em; margin-top:2px;">"${r.comment}"</div>
                </div>`;
            });
            reviewsHtml += `</div>`;
        }

        // üü¢ INJECT HTML
        card.innerHTML = `
          <div class="service-header">
            <div class="service-title">
              <h3>${serviceName}${availabilityBadge}</h3>
              <p class="service-description">${serviceDesc}</p>
            </div>
            <div class="service-price">$${servicePrice}</div>
          </div>
          
          <div class="service-details">
            <div class="service-detail"><strong>‚è±Ô∏è Duration:</strong> ${serviceDuration}</div>
            <div class="service-detail"><strong>üí∞ Payment:</strong> Cash only</div>
          </div>
          
          <div class="provider-info">
            <div class="provider-details">
              <strong>Provider:</strong> ${providerName}<br>
              <span class="rating">‚≠ê ${rating} <span style="font-weight:normal;color:#666;">(${count} reviews)</span></span>
            </div>
          </div>

          ${reviewsHtml}
        `;

        const bookButton = document.createElement('button');
        bookButton.textContent = availability === 'available' ? `Book Now` : 'Unavailable';
        bookButton.disabled = availability !== 'available';

        if (availability === 'available') {
          // Safe button click using closure (fixes the "Book Now" issue)
          bookButton.onclick = function() { openBookingModal(service); };
        }

        card.appendChild(bookButton);
        listDiv.appendChild(card);
      });
    }

    function openBookingModal(service) {
      selectedService = service;
      const modal = document.getElementById('bookingModal');
      const detailsDiv = document.getElementById('modalServiceDetails');

      const providerName = service.providerName || service.provider?.name || 'Unknown Provider';
      const providerRating = service.rating || service.provider?.rating || 0;

      detailsDiv.innerHTML = `
        <div class="service-card" style="margin:0 0 20px 0;">
          <h3>${service.name}</h3>
          <p><strong>Category:</strong> ${service.category || 'N/A'}</p>
          <p><strong>Price:</strong> ${parseFloat(service.price).toFixed(2)} (Cash payment on completion)</p>
          <p><strong>Duration:</strong> ${service.duration}</p>
          <p><strong>Provider:</strong> ${providerName} <span class="rating">${'‚≠ê'.repeat(Math.round(providerRating))} ${providerRating.toFixed(1)}</span></p>
        </div>
      `;

      modal.classList.add('active');

      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('scheduledDate').min = tomorrow.toISOString().split('T')[0];
    }

    function closeBookingModal() {
      const modal = document.getElementById('bookingModal');
      modal.classList.remove('active');
      document.getElementById('bookingForm').reset();
    }
    
    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
       e.preventDefault();
       const custId = 'cust-demo-' + Date.now();
       
       const bookingData = { 
          serviceId: selectedService.serviceId, 
          customerId: custId, 
          customerName: document.getElementById('customerName').value, 
          customerEmail: document.getElementById('customerEmail').value, 
          customerPhone: document.getElementById('customerPhone').value, 
          customerAddress: document.getElementById('customerAddress').value, 
          scheduledDate: document.getElementById('scheduledDate').value, 
          notes: document.getElementById('notes').value, 
          providerId: selectedService.providerId, 
          
          // üü¢ FIX: Explicitly sending these ensure the Invoice Lambda gets the data
          providerName: selectedService.providerName || selectedService.provider?.name || 'Unknown Provider', 
          serviceName: selectedService.name, 
          servicePrice: selectedService.price 
       };

       try {
         const res = await fetch(`${CONFIG.apiUrl}/bookings`, { 
             method:'POST', 
             headers:{'Content-Type':'application/json'}, 
             body:JSON.stringify(bookingData) 
         });
         
         if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
         
         const json = await res.json();
         
         if (json.bookingId) {
            sessionStorage.setItem('lastCustomerId', custId); 
            document.getElementById('customerIdLookup').value = custId;
            
            await showAlert(
                `<strong>‚úÖ Booking Confirmed!</strong><br>
                 <strong>ID:</strong> ${json.bookingId}<br>
                 <strong>Price:</strong> $${parseFloat(selectedService.price).toFixed(2)}<br><br>
                 Please save your Customer ID to track this booking.`, 
                'Success'
            ); 
            closeBookingModal();
         }
       } catch(e) { 
           console.error('Error:', e);
           await showAlert('Booking failed: ' + e.message, 'Error'); 
       }
    });

    async function loadMyBookings(direction = null) {
      const customerId = document.getElementById('customerIdLookup').value || sessionStorage.getItem('lastCustomerId');

      if (!customerId) {
        await showAlert('Please enter your Customer ID');
        return;
      }

      const bookingsDiv = document.getElementById('myBookings');
      const listDiv = document.getElementById('bookingsList');
      bookingsDiv.classList.remove('hidden');
      listDiv.innerHTML = '<div class="loading">üìã Loading your bookings...</div>';

      try {
        let url = `${CONFIG.apiUrl}/bookings?customerId=${encodeURIComponent(customerId)}`;

        if (direction === 'next' && bookingsPaginationToken) {
          url += `&lastKey=${encodeURIComponent(bookingsPaginationToken)}`;
          currentPage++;
        } else if (direction === 'prev' && bookingsPaginationHistory.length > 0) {
          bookingsPaginationHistory.pop();
          const prevToken = bookingsPaginationHistory[bookingsPaginationHistory.length - 1];
          if (prevToken) url += `&lastKey=${encodeURIComponent(prevToken)}`;
          currentPage--;
        } else if (!direction) {
          bookingsPaginationToken = null;
          bookingsPaginationHistory = [];
          currentPage = 1;
        }

        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

        const result = await response.json();

        if (result.bookings && result.bookings.length > 0) {
          displayCustomerBookings(result.bookings);

          const paginationDiv = document.getElementById('bookingsPagination');
          paginationDiv.classList.remove('hidden');
          document.getElementById('bookingsPageInfo').textContent = `Page ${currentPage}`;

          if (result.lastEvaluatedKey) {
            bookingsPaginationToken = result.lastEvaluatedKey;
            if (direction === 'next') bookingsPaginationHistory.push(result.lastEvaluatedKey);
            document.getElementById('nextBookings').disabled = false;
          } else {
            bookingsPaginationToken = null;
            document.getElementById('nextBookings').disabled = true;
          }

          document.getElementById('prevBookings').disabled = currentPage === 1;
        } else {
          listDiv.innerHTML = `
            <div class="info-box">
              <strong>No bookings found</strong><br>
              Customer ID: ${customerId}<br>
              Make your first booking to see it here!
            </div>
          `;
          document.getElementById('bookingsPagination').classList.add('hidden');
        }
      } catch (error) {
        console.error('Error:', error);
        listDiv.innerHTML = `<div class="content-card"><strong>Error loading bookings:</strong><br>${error.message}</div>`;
        document.getElementById('bookingsPagination').classList.add('hidden');
      }
    }

    function displayCustomerBookings(bookings) {
  const listDiv = document.getElementById('bookingsList');
  listDiv.innerHTML = '';

  bookings.forEach(booking => {
    const card = document.createElement('div');
    card.className = 'service-card';

    const status = (booking.status || 'UNKNOWN')
      .replace(/_/g, ' ')
      .toUpperCase();

    const bookingPrice = parseFloat(booking.servicePrice || 0).toFixed(2);

    card.innerHTML = `
      <div class="service-header">
        <div class="service-title">
          <h3>${booking.serviceName || 'Service'}</h3>
          <p><strong>Booking ID:</strong> ${booking.bookingId}</p>
        </div>
        <span class="status">${status}</span>
      </div>

      <div class="service-details">
        <div class="service-detail"><strong>üìû Phone:</strong> ${booking.customerPhone || 'N/A'}</div>
        <div class="service-detail"><strong>üë§ Provider:</strong> ${booking.providerName || 'TBD'}</div>
        <div class="service-detail"><strong>üí∞ Price:</strong> ${bookingPrice} CAD (Cash)</div>
        <div class="service-detail"><strong>üìÖ Scheduled:</strong> ${booking.scheduledDate || 'TBD'}</div>
        <div class="service-detail"><strong>üïê Booked:</strong> ${new Date(booking.createdAt).toLocaleDateString()}</div>
      </div>

      ${booking.customerAddress ? `<p><strong>üìç Address:</strong> ${booking.customerAddress}</p>` : ''}
      ${booking.notes ? `<p><strong>üìù Notes:</strong> ${booking.notes}</p>` : ''}
      ${
        ((booking.status || '').toUpperCase() === 'COMPLETED' && !booking.isReviewed)
          ? `<button onclick="openReviewModal('${booking.bookingId}', '${booking.providerId || ''}')">‚≠ê Rate</button>`
          : ''
      }
    `;

    listDiv.appendChild(card);

    // Fetch and display reviews
(async () => {
    const res = await fetch(`${CONFIG.apiUrl}/reviews?providerId=${booking.providerId}`);
    if (!res.ok) return;
    const data = await res.json();
    const reviews = data.reviews || [];
    const reviewSection = document.createElement('div');
    reviewSection.className = 'review-section';

    if (reviews.length > 0) {
        let html = `<div class='review-scroll-box'><h4>Customer Reviews (${reviews.length})</h4>`;

        reviews.forEach(r => {
            const stars = '‚òÖ'.repeat(Math.round(r.rating)) + '‚òÜ'.repeat(5 - Math.round(r.rating));
            html += `
                <div class="review-item">
                    <div class="review-header">
                        <span class="review-stars">${stars}</span>
                        <span class="review-date">${r.date}</span>
                    </div>
                    <div class="review-text">${r.comment}</div>
                </div>
            `;
        });

        html += `</div>`;
        reviewSection.innerHTML = html;
        card.appendChild(reviewSection);
    }
})();;
  });
}

    /* ===== EVENT LISTENERS ===== */
    window.addEventListener('click', (event) => {
      const modal = document.getElementById('bookingModal');
      if (event.target === modal) closeBookingModal();
    });
    /* ===== REVIEW LOGIC ===== */
    function openReviewModal(bid, pid) {
       document.getElementById('reviewBookingId').value = bid; 
       document.getElementById('reviewProviderId').value = pid;
       document.getElementById('reviewForm').reset(); 
       setRating(0);
       document.getElementById('reviewModal').classList.add('active');
    }
    function closeReviewModal() { document.getElementById('reviewModal').classList.remove('active'); }

    function setRating(n) { 
       currentRating = n; 
       const stars = document.getElementById('starContainer').children; 
       for(let i=0;i<5;i++) stars[i].style.color = i<n ? '#ff9900':'#ccc'; 
    }

    document.getElementById('reviewForm').addEventListener('submit', async (e) => {
       e.preventDefault(); 
       if(!currentRating) return showAlert('Rating required');
       const data = { 
          bookingId: document.getElementById('reviewBookingId').value, 
          providerId: document.getElementById('reviewProviderId').value, 
          rating: currentRating, 
          comment: document.getElementById('reviewComment').value 
       };
       try {
         await fetch(`${CONFIG.apiUrl}/reviews`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
         await showAlert('Thanks for your review!', 'Success'); 
         closeReviewModal(); 
         loadMyBookings(); // Refresh to hide button
       } catch(e) { showAlert('Failed to submit review.'); }
    });

  </script>
</body>
</html>